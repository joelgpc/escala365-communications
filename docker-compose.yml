version: '3.8'

services:
  mariadb:
    image: mariadb:10.6
    container_name: mariadb
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: "${DB_ROOT_PASSWORD}"
      MYSQL_DATABASE: suitecrm
      MYSQL_USER: suitecrm_user
      MYSQL_PASSWORD: "${DB_PASSWORD}"
    volumes:
      - mariadb_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  suitecrm:
    image: php:8.1-apache
    container_name: suitecrm
    restart: always
    depends_on:
      mariadb:
        condition: service_healthy
    volumes:
      # IMPORTANTE: Mapeamos el archivo expl√≠citamente
      - ./suitecrm/docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh:ro
      - suitecrm_data:/var/www/html
    entrypoint: ["/usr/local/bin/docker-entrypoint.sh"]
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
      - SUITECRM_DATABASE_HOST=mariadb
      - SUITECRM_DATABASE_USER=suitecrm_user
      - SUITECRM_DATABASE_PASSWORD=${DB_PASSWORD}
      - SUITECRM_DATABASE_NAME=suitecrm
    ports:
      - "8080:80"

  asterisk:
    image: andrius/asterisk:22
    container_name: asterisk
    restart: always
    network_mode: host
    cap_add:
      - SYS_PTRACE
      - NET_ADMIN
      - NET_RAW
      - NET_BIND_SERVICE
    volumes:
      - asterisk_config:/etc/asterisk
      - asterisk_spool:/var/spool/asterisk
      - asterisk_sounds:/var/lib/asterisk/sounds
    environment:
      - AMI_PASSWORD=${AMI_PASSWORD}

volumes:
  mariadb_data:
  suitecrm_data:
  asterisk_config:
  asterisk_spool:
  asterisk_sounds:
