[globals]
; Variables globales
RECORDING_PATH=/var/spool/asterisk/monitor

[from-external]
; ===== LLAMADAS ENTRANTES =====
exten => _X.,1,NoOp(*** Llamada entrante desde ${CALLERID(num)} ***)
 same => n,Answer()
 same => n,Wait(1)
 
 ; CUMPLIMIENTO LSSICE: Av iso obligatorio de grabación
 same => n,Playback(custom/aviso-legal-es)
 
 ; Iniciar grabación DESPUÉS del aviso
 same => n,Set(CALLFILENAME=${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}-${CALLERID(num)}-${UNIQUEID})
 same => n,MixMonitor(${RECORDING_PATH}/${CALLFILENAME}.wav,b)
 
 ; Registrar en CDR para integración CRM
 same => n,Set(CDR(userfield)=InboundCall)
 same => n,Set(CDR(accountcode)=${CALLERID(num)})
 
 ; IVR básico
 same => n(menu),Background(custom/menu-principal)
 same => n,WaitExten(10)
 
 ; Timeout: enviar a cola
 same => n,Goto(queue-soporte,s,1)

exten => 1,1,NoOp(*** Opción 1: Soporte Técnico ***)
 same => n,Goto(queue-soporte,s,1)

exten => 2,1,NoOp(*** Opción 2: Ventas ***)
 same => n,Goto(queue-ventas,s,1)

exten => 9,1,NoOp(*** Opción 9: Detener grabación (Derecho oposición RGPD) ***)
 same => n,StopMixMonitor()
 same => n,Playback(beep)
 same => n,Goto(menu)

exten => i,1,Playback(invalid)
 same => n,Goto(menu)

exten => t,1,Goto(queue-soporte,s,1)

; ===== COLA DE SOPORTE =====
[queue-soporte]
exten => s,1,NoOp(*** Entrando a cola de soporte ***)
 same => n,Set(CHANNEL(language)=es)
 same => n,Queue(soporte,tTr,,,300)
 same => n,Voicemail(100@default,u)
 same => n,Hangup()

; ===== COLA DE VENTAS =====
[queue-ventas]
exten => s,1,NoOp(*** Entrando a cola de ventas ***)
 same => n,Set(CHANNEL(language)=es)
 same => n,Queue(ventas,tTr,,,300)
 same => n,Voicemail(200@default,u)
 same => n,Hangup()

; ===== CONTEXTO AGENTES =====
[from-internal]
; Llamadas salientes de agentes
exten => _9XXXXXXXXX,1,NoOp(*** Llamada saliente: Agente ${CALLERID(num)} -> ${EXTEN:1} ***)
 same => n,Set(OUTBOUND_NUMBER=${EXTEN:1})
 
 ; CUMPLIMIENTO: Verificar Lista Robinson
 same => n,AGI(robinson-check.py,${OUTBOUND_NUMBER})
 same => n,GotoIf($["${ROBINSON_BLOCKED}" = "1"]?blocked:continue)
 
 same => n(blocked),Playback(custom/numero-bloqueado-robinson)
 same => n,Congestion(5)
 same => n,Hangup()
 
 same => n(continue),Set(CALLFILENAME=${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}-OUT-${OUTBOUND_NUMBER})
 same => n,MixMonitor(${RECORDING_PATH}/${CALLFILENAME}.wav)
 same => n,Set(CDR(userfield)=OutboundCall)
 same => n,Dial(PJSIP/${OUTBOUND_NUMBER}@trunk-provider,60,tTr)
 same => n,Hangup()

; Transferencia entre agentes
exten => _1XX,1,NoOp(*** Transferencia interna a extensión ${EXTEN} ***)
 same => n,Dial(PJSIP/${EXTEN},30,tTr)
 same => n,Hangup()
